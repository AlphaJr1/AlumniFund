rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function untuk check admin
    function isAdmin() {
      return request.auth != null && 
        request.auth.token.email in [
          'admin@dompet-alumni.com',
          'adrianalfajri@gmail.com',
        ];
    }
    
    // ========================================
    // PUBLIC COLLECTIONS (Read-only for all)
    // ========================================
    
    // General Fund
    match /general_fund/{document} {
      allow read: if true; // Public can read
      allow write: if isAdmin(); // Only admin can write
    }
    
    // Graduation Targets
    match /graduation_targets/{targetId} {
      allow read: if true; // Public can read
      allow write: if isAdmin(); // Only admin can write
    }
    
    // Transactions
    match /transactions/{transactionId} {
      allow read: if true; // Public can read
      allow write: if isAdmin(); // Only admin can write
    }
    
    // Settings (app_config document)
    match /settings/{configId} {
      allow read: if true; // Public can read settings
      allow write: if isAdmin(); // Only admin can write
    }
    
    // ========================================
    // PUBLIC WRITE COLLECTIONS
    // ========================================
    
    // Income Submissions (public can create)
    match /income_submissions/{submissionId} {
      allow read: if true; // Public can read
      allow create: if true; // Anyone can submit
      allow update, delete: if isAdmin(); // Only admin can update/delete
    }
    
    // Pending Submissions (alias/old name)
    match /pending_submissions/{submissionId} {
      allow read: if true;
      allow create: if true;
      allow update, delete: if isAdmin();
    }
    
    // Onboarding Feedbacks (public can create)
    match /onboarding_feedbacks/{feedbackId} {
      allow create: if true; // Anyone can submit feedback
      allow read, update: if isAdmin(); // Only admin can read/update
      allow delete: if false; // No delete allowed
    }
    
    // ========================================
    // ADMIN-ONLY COLLECTIONS
    // ========================================
    
    // Admin Users
    match /admin_users/{userId} {
      allow read, write: if isAdmin();
    }
    
    // Expenses
    match /expenses/{expenseId} {
      allow read: if true; // Public can read
      allow write: if isAdmin(); // Only admin can write
    }
    
    // ========================================
    // CLOUD FUNCTIONS GENERATED DATA
    // ========================================
    
    // Analytics (generated by Cloud Functions)
    match /analytics/{docId} {
      allow read: if true; // Public can read
      allow write: if isAdmin(); // Only admin/functions can write
    }
    
    // Target Analytics (generated by Cloud Functions)
    match /target_analytics/{docId} {
      allow read: if true; // Public can read
      allow write: if isAdmin(); // Only admin/functions can write
    }
    
    // ========================================
    // STORAGE METADATA (if any)
    // ========================================
    
    // Donor Images metadata
    match /donor_images/{imageId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Payment Methods
    match /payment_methods/{methodId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // QR Codes
    match /qr_codes/{qrId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
